#!/bin/bash
PREFIX=/usr/local
LIB=${PREFIX}/lib

CLI=aeten-cli.sh
check="./${CLI} check"
addprefix='./aeten-gen-build.bash add-prefix'
target='./aeten-gen-build.bash target'

LIB_DIR=$(readlink -f "${LIB}")
COMMANDS=$(. ./${CLI} && __aeten_cli_api ${CLI} | grep -v '^import$')
LINKS=$(${addprefix} ${PREFIX}/bin/ ${COMMANDS})
MAKE_INCLUDE=$(${addprefix} ${LIB_DIR}/ "${CLI/.sh/.mk}")

$(./${CLI} import check)

check -m "Generates build.ninja" ./aeten-gen-build.bash <<EOF
LIB_DIRNAME = $(dirname ${LIB_DIR})
INSTALLED_CLI = ${LIB_DIR}/${CLI}
LINKS = ${LINKS}
LIB_DIR = ${LIB_DIR}
CLI_MK = ${CLI/.sh/.mk}
check = ${check}
CLI = ${CLI}
LINK_BUILDS = $(${target} --depends "symlink ${LIB_DIR}/${CLI}" ${LINKS})
EOF
