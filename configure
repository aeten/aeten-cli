#!/bin/bash

while [ ${#} -ne 0 ]; do
	case "${1}" in
		-b|--builder) builder=${2}; shift;;
		-p|--prefix)  prefix=${2}; shift;;
	esac
	shift
done

: ${prefix:=/usr/local}
LIB_DIR="${prefix}/lib"
BIN_DIR="${prefix}/bin"
AETEN_MAKE=$(dirname ${0})/aeten-make
CLI=aeten-cli.sh
ADS=aeten-ads
$($(dirname ${0})/${CLI} import check confirm)

: ${builder:=$(./${CLI} confirm --no 'Use Ninja instead of GNU Make?' && echo ninja || echo make)}

case "${builder}" in
	ninja)
		template=template.ninja
		build_script=build.ninja;;
	make)
		template=template.mk
		build_script=makefile
		check -m 'Generates GNU Make template' "${AETEN_MAKE}/ninja2make template.ninja|sed 's,@@check@@,./${CLI} check,g' > template.mk";;
esac

check="./${CLI} check"
addprefix="${AETEN_MAKE}/generate-builder add-prefix"
target="${AETEN_MAKE}/generate-builder target --builder ${builder}"

COMMANDS=$(. ./${CLI} && __aeten_cli_api ${CLI} | grep -v '^import$')
LINKS=$(${addprefix} ${BIN_DIR}/ ${COMMANDS})

check -m "Generates ${build_script}" $(dirname ${0})/aeten-make/generate-builder -t ${template} "${@}" <<EOF '>' ${build_script}
LIB_DIR = ${LIB_DIR}
CLI = ${CLI}
ADS = ${ADS}
LINKS = ${BIN_DIR}/ads ${LINKS}
LINK_BUILDS = $(${target} --command symlink --depends "${LIB_DIR}/${ADS}" ${BIN_DIR}/ads)\\\n$(${target} --command symlink --depends "${LIB_DIR}/${CLI}" ${LINKS})
EOF

[ ${builder} = make ] && rm template.mk
