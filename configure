#!/bin/bash

while [ ${#} -ne 0 ]; do
	case "${1}" in
		-b|--builder) builder=${2}; shift;;
		-p|--prefix)  prefix=${2}; shift;;
	esac
	shift
done

: ${prefix:=/usr/local}
LIB_DIR="${prefix}/lib"
BIN_DIR="${prefix}/bin"
CLI=aeten-cli.sh
$(./${CLI} import check confirm)

: ${builder:=$(./${CLI} confirm --no 'Use Ninja instead of GNU Make?' && echo ninja || echo make)}

case "${builder}" in
	ninja)
		template=template.ninja
		build_script=build.ninja;;
	make)
		template=template.mk
		build_script=makefile
		check -m 'Generates GNU Make template' "./ninja2make.sed template.ninja|sed 's,@@check@@,./${CLI} check,g' > template.mk";;
esac

check="./${CLI} check"
addprefix='./aeten-gen-build.bash add-prefix'
target="./aeten-gen-build.bash target --builder ${builder}"

COMMANDS=$(. ./${CLI} && __aeten_cli_api ${CLI} | grep -v '^import$')
LINKS=$(${addprefix} ${BIN_DIR}/ ${COMMANDS})

check -m "Generates ${build_script}" ./aeten-gen-build.bash -t ${template} "${@}" <<EOF '>' ${build_script}
LIB_DIR = ${LIB_DIR}
CLI = ${CLI}
LINKS = ${LINKS}
LINK_BUILDS = $(${target} --command symlink --depends "${LIB_DIR}/${CLI}" ${LINKS})
EOF

[ ${builder} = make ] && rm template.mk
